<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDA Generator - Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles (Copied from index.js with minor adjustments) */
        .header-container {
            background-color: #ffffff;
            padding: 15px 50px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Subtle shadow for header */
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .company-brand {
            font-size: 14px;
            line-height: 1.1;
            color: #666;
            text-align: left;
            font-weight: 500;
        }
        .company-brand .bharat-text {
            color: #4285F4;
            font-weight: 700;
        }
        .separator {
            font-size: 24px;
            color: #ccc;
            font-weight: 300;
        }
        .project-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .user-info-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-display {
            text-align: right;
        }
        #welcomeUserName {
            display: block;
            font-weight: 600;
            color: #333;
        }
        #welcomeUserEmail {
            display: block;
            font-size: 0.9em;
            color: #666;
        }
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            padding: 8px 15px;
            background-color: #dc3545; /* Red for logout */
            color: white;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .logout-icon {
            font-size: 1.2em;
            line-height: 1;
        }

        /* Main Content Layout */
        .main-body-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr; /* Default to single column */
            gap: 25px;
            padding: 25px;
            max-width: 1200px;
            margin: 25px auto;
        }
        @media (min-width: 768px) {
            .main-body-container {
                grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
            }
        }

        /* Card/Section Styles */
        .section-card {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between elements in the card */
        }
        .section-card h3 {
            margin-top: 0;
            font-size: 1.5em;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* Input Group Styles */
        .input-group {
            margin-bottom: 0; /* Remove default margin as gap handles spacing */
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }
        input[type="text"]:focus,
        input[type="date"]:focus {
            border-color: #4285F4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        input[type="text"][readonly],
        input[type="date"][readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Button Styles */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none; /* For anchor tags acting as buttons */
            display: inline-flex; /* Align text and icon if needed */
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #4285F4; /* Google Blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #357ae8;
        }

        .btn-secondary {
            background-color: #6c757d; /* Gray */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-info {
            background-color: #17a2b8; /* Info blue */
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }

        .btn-success {
            background-color: #28a745; /* Green */
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }

        /* Specific Button placements */
        .party-a-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; /* Space between Party A buttons and first input */
            flex-wrap: wrap;
        }
        .bottom-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .bottom-actions .btn {
            width: fit-content; /* Adjust width to content */
        }

        #savedMessage {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Modal Styles - Adjusted for new theme */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 900px; /* Slightly wider modal to accommodate more columns */
            max-height: 85vh; /* Taller modal */
            overflow-y: auto;
            position: relative;
            text-align: left;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.6em;
        }
        .modal-content table {
            width: 100%;
            border-collapse: separate; /* Use separate to allow border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
            margin-top: 15px;
            border: 1px solid #ddd; /* Outer border for the table */
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures child elements respect border-radius */
        }
        .modal-content th, .modal-content td {
            border: none; /* Remove individual cell borders */
            border-bottom: 1px solid #eee; /* Only bottom border for rows */
            padding: 12px 15px;
            text-align: left;
        }
        .modal-content th {
            background-color: #f8f9fa; /* Lighter header background */
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .modal-content tr:last-child td {
            border-bottom: none; /* No bottom border for the last row */
        }
        .modal-content tr:hover {
            background-color: #eaf3ff; /* Lighter blue hover */
            cursor: pointer;
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px; /* Larger close button */
            cursor: pointer;
            border: none;
            background: none;
            color: #777;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        #partyALoadingMessage, #partyAErrorMessage {
            padding: 10px;
            background-color: #f8d7da; /* Light red background for error */
            color: #721c24; /* Darker red text */
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
        #partyALoadingMessage {
            background-color: #d1ecf1; /* Light blue background for loading */
            color: #0c5460;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="logo">
            <div class="company-brand">
                <span class="bharat-text">bharat</span><br>
                <span>valley</span>
            </div>
            <span class="separator">|</span>
            <span class="project-name">NDA Generator</span>
        </div>
        <div class="user-info-section">
            <div class="user-display">
                <span id="welcomeUserName"></span>
                <span class="user-email" id="welcomeUserEmail"></span>
            </div>
            <a href="/logout" class="logout-btn">
                <span class="logout-icon">â†’</span> Logout
            </a>
        </div>
    </div>

    <div class="main-body-container">
        <!-- Input Block for Date -->
        <div class="section-card">
            <h3>Agreement Details</h3>
            <div class="input-group">
                <label for="inputDate">Date:</label>
                <input type="date" id="inputDate">
            </div>
        </div>

        <!-- NEW: Section for Party A Company Details -->
        <div class="section-card company-a-section">
            <h3>Party A Company Details</h3>
            <div class="party-a-buttons">
                <button onclick="openPartyASelectionModal()" class="btn btn-primary">Select from List</button>
                <button onclick="clearPartyASelection()" class="btn btn-secondary">Clear Selection</button>
            </div>

            <div class="input-group">
                <label for="companyNameA">Company Name A:</label>
                <input type="text" id="companyNameA" placeholder="Enter Company Name A">
            </div>

            <div class="input-group">
                <label for="llpin">LLPIN:</label>
                <input type="text" id="llpin" placeholder="Enter LLPIN">
            </div>

            <div class="input-group">
                <label for="addressA">Address A:</label>
                <input type="text" id="addressA" placeholder="Enter Address A">
            </div>
        </div>
        <!-- END NEW: Section for Party A Company Details -->

        <!-- Section for Company B -->
        <div class="section-card company-b-section">
            <h3>Party B Details</h3>
            <div class="input-group">
                <label for="companyNameB">Company Name B:</label>
                <input type="text" id="companyNameB" placeholder="Enter Company Name B">
            </div>

            <div class="input-group">
                <label for="cin">CIN:</label>
                <input type="text" id="cin" placeholder="Enter CIN">
            </div>

            <div class="input-group">
                <label for="addressB">Address B:</label>
                <input type="text" id="addressB" placeholder="Enter Address B">
            </div>
        </div>

        <!-- NEW: Section for CA Firm Details (Moved after Company B) -->
        <div class="section-card ca-firm-section">
            <h3>CA Firm Details for Party A</h3>
            <p>These fields are populated automatically when Party A is selected from the list.</p>
            <div class="input-group">
                <label for="caFirmName">CA Firm Name:</label>
                <input type="text" id="caFirmName" placeholder="CA Firm Name">
            </div>
            <div class="input-group">
                <label for="caName">CA Name:</label>
                <input type="text" id="caName" placeholder="CA Name">
            </div>
            <div class="input-group">
                <label for="memberRegNo">Member Reg No:</label>
                <input type="text" id="memberRegNo" placeholder="Member Registration Number">
            </div>
            <div class="input-group">
                <label for="partnerProprietor">Partner/Proprietor:</label>
                <input type="text" id="partnerProprietor" placeholder="Partner or Proprietor Name">
            </div>
        </div>
        <!-- END NEW: Section for CA Firm Details -->

        <!-- Actions/Save Section -->
        <div class="section-card bottom-actions">
            <h3>Actions</h3>
            <button onclick="saveInput()" class="btn btn-success">Save Agreement Details</button>
            <p id="savedMessage"></p>
            <a href="/display.html" class="btn btn-info">View Last Saved Entry</a> 
        </div>
    </div>

    <!-- Party A Selection Modal -->
    <div id="partyASelectionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closePartyASelectionModal()">&times;</button>
            <h3>Select Party A Details</h3>
            <p id="partyALoadingMessage">Loading options...</p>
            <p id="partyAErrorMessage" style="display: none;"></p>
            <div id="partyAOptionsTableContainer">
                <!-- Options table will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let currentUserEmail = 'N/A';
        let currentUserName = 'User';

        async function fetchUserData() {
            try {
                const response = await fetch('/profile-data');
                if (response.ok) {
                    const data = await response.json();
                    currentUserName = data.user.displayName || data.user.email;
                    currentUserEmail = data.user.email;
                    document.getElementById('welcomeUserName').innerText = currentUserName;
                    document.getElementById('welcomeUserEmail').innerText = currentUserEmail;
                } else if (response.status === 401) {
                    window.location.href = '/';
                } else {
                    console.error('Failed to fetch user data');
                    document.getElementById('welcomeUserName').innerText = 'Guest';
                    document.getElementById('welcomeUserEmail').innerText = 'N/A';
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                document.getElementById('welcomeUserName').innerText = 'Guest';
                document.getElementById('welcomeUserEmail').innerText = 'N/A';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchUserData();
            // Initially make ALL Party A and CA fields editable
            setPartyAFieldsReadOnly(false);
            // Set today's date as default
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('inputDate').value = `${yyyy}-${mm}-${dd}`;
        });

        // Function to handle saving inputs
        async function saveInput() {
            const inputDate = document.getElementById('inputDate').value;
            const companyNameA = document.getElementById('companyNameA').value;
            const llpin = document.getElementById('llpin').value;
            const addressA = document.getElementById('addressA').value;
            // Get values for CA Firm Details
            const caFirmName = document.getElementById('caFirmName').value;
            const caName = document.getElementById('caName').value;
            const memberRegNo = document.getElementById('memberRegNo').value;
            const partnerProprietor = document.getElementById('partnerProprietor').value;

            const companyNameB = document.getElementById('companyNameB').value;
            const cin = document.getElementById('cin').value;
            const addressB = document.getElementById('addressB').value;
            const savedMessageElement = document.getElementById('savedMessage');

            // --- Basic validation check for at least one field ---
            if (!inputDate.trim() && !companyNameA.trim() && !llpin.trim() && !addressA.trim() && !caFirmName.trim() && !caName.trim() && !memberRegNo.trim() && !partnerProprietor.trim() && !companyNameB.trim() && !cin.trim() && !addressB.trim()) {
                savedMessageElement.style.color = 'red';
                savedMessageElement.innerText = 'Please enter at least one field before saving.';
                return;
            }

            try {
                const res = await fetch('/api/save-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Send both spaced keys (for Excel headers) and camelCase (for backward compatibility)
                        'User Email': currentUserEmail,
                        'Date': inputDate,
                        'Company Name A': companyNameA,
                        'LLPIN': llpin,
                        'Address A': addressA,
                        'CA FIRM NAME': caFirmName,
                        'CA NAME': caName,
                        'MEMBER REG NO': memberRegNo,
                        'PARTNER/PROPRIETOR': partnerProprietor,
                        'Company Name B': companyNameB,
                        'CIN': cin,
                        'Address B': addressB,
                        // Also send camelCase for potential alternative parsing
                        userEmail: currentUserEmail,
                        date: inputDate,
                        companyNameA,
                        llpin,
                        addressA,
                        caFirmName,
                        caName,
                        memberRegNo,
                        partnerProprietor,
                        companyNameB,
                        cin,
                        addressB
                    })
                });

                const result = await res.json();
                if (res.ok && result.success) {
                    savedMessageElement.style.color = 'green';
                    savedMessageElement.innerText = 'Data saved successfully.';
                } else {
                    savedMessageElement.style.color = 'red';
                    savedMessageElement.innerText = result.message || 'Failed to save data.';
                }
            } catch (error) {
                console.error('Save failed:', error);
                savedMessageElement.style.color = 'red';
                savedMessageElement.innerText = 'Could not save data.';
            }
        }

        // Party A Selection Modal Functions
        function openPartyASelectionModal() {
            document.getElementById('partyASelectionModal').style.display = 'flex';
            fetchPartyAOptions();
        }

        function closePartyASelectionModal() {
            document.getElementById('partyASelectionModal').style.display = 'none';
        }

        function setPartyAFieldsReadOnly(isReadOnly) {
            document.getElementById('companyNameA').readOnly = isReadOnly;
            document.getElementById('llpin').readOnly = isReadOnly;
            document.getElementById('addressA').readOnly = isReadOnly;
            // Set readOnly for new CA Firm fields
            document.getElementById('caFirmName').readOnly = isReadOnly;
            document.getElementById('caName').readOnly = isReadOnly;
            document.getElementById('memberRegNo').readOnly = isReadOnly;
            document.getElementById('partnerProprietor').readOnly = isReadOnly;
            
            // Also adjust background color to indicate read-only status
            document.getElementById('companyNameA').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('llpin').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('addressA').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('caFirmName').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('caName').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('memberRegNo').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
            document.getElementById('partnerProprietor').style.backgroundColor = isReadOnly ? '#e9ecef' : 'white';
        }

        function clearPartyASelection() {
            document.getElementById('companyNameA').value = '';
            document.getElementById('llpin').value = '';
            document.getElementById('addressA').value = '';
            // Clear new CA Firm fields
            document.getElementById('caFirmName').value = '';
            document.getElementById('caName').value = '';
            document.getElementById('memberRegNo').value = '';
            document.getElementById('partnerProprietor').value = '';
            
            setPartyAFieldsReadOnly(false); // Make fields editable again
            document.getElementById('savedMessage').innerText = ''; // Clear any previous save message
        }

        async function fetchPartyAOptions() {
            const loadingMsg = document.getElementById('partyALoadingMessage');
            const errorMsg = document.getElementById('partyAErrorMessage');
            const tableContainer = document.getElementById('partyAOptionsTableContainer');

            loadingMsg.style.display = 'block';
            errorMsg.style.display = 'none';
            tableContainer.innerHTML = '';

            try {
                const response = await fetch('/api/get-party-a-options');
                if (response.status === 401) {
                    window.location.href = '/'; // Redirect to login if unauthorized
                    return;
                }
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                const data = await response.json();

                loadingMsg.style.display = 'none';

                if (data.success && data.options && data.options.length > 0) {
                    // Add headers for all Party A and CA Firm details to the modal table
                    let tableHtml = '<table><thead><tr><th>Company Name</th><th>LLPIN</th><th>Address</th><th>CA Firm Name</th><th>CA Name</th><th>Member Reg No</th><th>Partner/Proprietor</th></tr></thead><tbody>';
                    data.options.forEach(option => {
                        // Ensure keys match Excel headers
                        const companyName = option['Company Name'] || '';
                        const llpin = option['LLPIN'] || '';
                        const address = option['Address'] || '';
                        // Extract new CA Firm fields
                        const caFirmName = option['CA FIRM NAME'] || '';
                        const caName = option['CA NAME'] || '';
                        const memberRegNo = option['MEMBER REG NO'] || '';
                        const partnerProprietor = option['PARTNER/PROPRIETOR'] || '';
                        
                        // Pass all fields to selectPartyAOption. Use escape() for URL-safe strings.
                        tableHtml += `<tr onclick="selectPartyAOption(
                                        '${escape(companyName)}',
                                        '${escape(llpin)}',
                                        '${escape(address)}',
                                        '${escape(caFirmName)}',
                                        '${escape(caName)}',
                                        '${escape(memberRegNo)}',
                                        '${escape(partnerProprietor)}'
                                      )">
                                        <td>${escapeHtml(companyName)}</td>
                                        <td>${escapeHtml(llpin)}</td>
                                        <td>${escapeHtml(address)}</td>
                                        <td>${escapeHtml(caFirmName)}</td>
                                        <td>${escapeHtml(caName)}</td>
                                        <td>${escapeHtml(memberRegNo)}</td>
                                        <td>${escapeHtml(partnerProprietor)}</td>
                                      </tr>`;
                    });
                    tableHtml += '</tbody></table>';
                    tableContainer.innerHTML = tableHtml;
                } else {
                    tableContainer.innerHTML = '<p>No Party A options found in the Excel file. Please ensure worked_for.xlsx has a sheet with "Company Name", "LLPIN", "Address", "CA FIRM NAME", "CA NAME", "MEMBER REG NO", and "PARTNER/PROPRIETOR" headers.</p>';
                }

            } catch (error) {
                console.error('Error fetching Party A options:', error);
                loadingMsg.style.display = 'none';
                errorMsg.innerText = `Failed to load Party A options: ${error.message}. Please check server logs.`;
                errorMsg.style.display = 'block';
            }
        }

        // Function signature to accept all Party A and CA Firm fields
        function selectPartyAOption(companyName, llpin, address, caFirmName, caName, memberRegNo, partnerProprietor) {
            document.getElementById('companyNameA').value = unescape(companyName);
            document.getElementById('llpin').value = unescape(llpin);
            document.getElementById('addressA').value = unescape(address);
            // Populate new CA Firm fields
            document.getElementById('caFirmName').value = unescape(caFirmName);
            document.getElementById('caName').value = unescape(caName);
            document.getElementById('memberRegNo').value = unescape(memberRegNo);
            document.getElementById('partnerProprietor').value = unescape(partnerProprietor);

            setPartyAFieldsReadOnly(true); // Make fields read-only after selection
            closePartyASelectionModal();
        }

        // Simple HTML escape for display within the table (to prevent XSS)
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>

